<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard ‚Äî Helpdesk‚ÄëAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preload" href="/static/css/theme.css" as="style">
    <link rel="stylesheet" href="/static/css/theme.css">
  </head>
  <body class="min-h-screen text-slate-100 grain vignette">
    <!-- Animated BG Orbs -->
    <div class="bg-orbs">
      <div class="orb f1"></div>
      <div class="orb f2"></div>
      <div class="orb f3"></div>
    </div>

    <div class="relative mx-auto max-w-5xl px-6 py-10">
      <!-- Header -->
      <header class="mb-8 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-fuchsia-500 to-cyan-400 shadow-lg shadow-fuchsia-500/30 tilt"></div>
          <div>
            <div class="text-xl font-semibold tracking-tight">Welcome, {{ user.username }}!</div>
            <div class="text-xs text-slate-400">Ask anything ‚Äî I‚Äôll fix it or open a ticket</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a href="/admin/tickets" class="hidden rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-sm text-slate-300 transition hover:bg-white/10" id="adminLink">Admin</a>
          <button onclick="logout()" class="btn-funky rounded-lg px-3 py-2 text-sm">Logout</button>
        </div>
      </header>

      <!-- AI Assistant Widget -->
      <div class="glass rounded-3xl p-6">
        <div class="mx-auto w-full max-w-2xl">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold tracking-tight">Helpdesk‚ÄëAI Assistant</h2>
            <div class="rounded-full border border-white/10 bg-white/5 px-2 py-1 text-[10px] text-white/70">
              beta
            </div>
          </div>

          <!-- Conversation area -->
          <div id="conversation" class="mt-4 rounded-xl bubble p-3 text-sm text-slate-200 shadow-inner">
            <div class="text-slate-400">Ask about any IT issue. I'll propose a fix or open a ticket.</div>
          </div>

          <!-- Form -->
          <form id="assistantForm" class="mt-4 grid gap-3">
            <textarea
              id="messageInput"
              class="min-h-28 w-full resize-y rounded-2xl border border-white/10 bg-white/5 p-3 text-sm text-white placeholder:text-slate-400 shadow-[inset_0_1px_0_rgba(255,255,255,0.06)] outline-none backdrop-blur transition focus:border-fuchsia-400/40 focus:ring-2 focus:ring-fuchsia-400/20 tilt"
              placeholder="Describe your issue‚Ä¶"
              rows="4"
              required
            ></textarea>
            <button
              type="submit"
              id="submitBtn"
              class="btn-funky relative inline-flex items-center justify-center gap-2 overflow-hidden rounded-2xl px-4 py-2.5 text-sm font-semibold shadow-[0_10px_30px_-10px_rgba(244,114,182,0.6)] focus:outline-none enabled:hover:scale-[1.02] disabled:opacity-60"
            >
              <span id="btnText" class="relative z-10">Ask</span>
              <span id="btnIcon" class="relative z-10 text-base">‚Üí</span>
            </button>
          </form>

          <div class="mt-2 text-[11px] text-slate-400">We may open a ticket automatically if a human expert is needed.</div>
        </div>
      </div>

      <!-- Remote PC Connection Feature -->
      <div class="relative mt-8 glass rounded-3xl p-6 overflow-hidden">
        <div class="mx-auto w-full max-w-4xl">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="h-8 w-8 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-400 shadow-lg shadow-emerald-500/30 flex items-center justify-center">
                <svg class="w-4 h-4 text-emerald-900" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
              </div>
              <div>
                <h2 class="text-lg font-semibold tracking-tight">Remote PC Access</h2>
                <p class="text-xs text-slate-400">AI fixes your PC remotely via secure connection</p>
              </div>
            </div>
            <div class="rounded-full border border-emerald-400/30 bg-emerald-400/10 px-2 py-1 text-[10px] text-emerald-300">
              powered by NinjaOne
            </div>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <!-- Connection Status -->
            <div class="space-y-4">
              <div class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-black/20">
                <div class="flex-shrink-0">
                  <div id="connectionStatus" class="h-3 w-3 rounded-full bg-red-400 shadow-lg shadow-red-400/50"></div>
                </div>
                <div class="flex-1">
                  <div class="text-sm font-medium text-white">PC Connection</div>
                  <div id="connectionText" class="text-xs text-slate-400">Not connected</div>
                </div>
              </div>

              <button 
                id="connectPcBtn" 
                class="btn-funky w-full rounded-xl px-4 py-3 text-sm font-semibold shadow-[0_10px_30px_-10px_rgba(16,185,129,0.6)] transition enabled:hover:scale-[1.02]"
              >
                <span class="flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M12.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                  </svg>
                  <span id="connectBtnText">Connect My PC</span>
                </span>
              </button>

              <button 
                id="remoteSessionBtn" 
                class="hidden w-full rounded-xl border border-emerald-400/30 bg-emerald-400/10 px-4 py-2.5 text-sm font-semibold text-emerald-200 transition hover:bg-emerald-400/20 hover:scale-[1.02] mt-2"
              >
                <span class="flex items-center justify-center gap-2">
                  <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                  </svg>
                  Open Remote Session
                </span>
              </button>

              <div class="text-[11px] text-slate-400 leading-relaxed">
                üîí Secure RMM connection ‚Ä¢ ü§ñ AI auto-diagnosis ‚Ä¢ ‚ö° Instant fixes
              </div>
            </div>

            <!-- AI Capabilities Preview -->
            <div class="space-y-3">
              <div class="text-sm font-medium text-slate-300 mb-2">What AI can fix remotely:</div>
              <div class="space-y-2">
                <div class="flex items-center gap-2 text-xs text-slate-400">
                  <div class="h-1.5 w-1.5 rounded-full bg-cyan-400"></div>
                  <span>Software installation & updates</span>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-400">
                  <div class="h-1.5 w-1.5 rounded-full bg-fuchsia-400"></div>
                  <span>Registry & system optimization</span>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-400">
                  <div class="h-1.5 w-1.5 rounded-full bg-emerald-400"></div>
                  <span>Network connectivity issues</span>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-400">
                  <div class="h-1.5 w-1.5 rounded-full bg-amber-400"></div>
                  <span>Driver conflicts & hardware setup</span>
                </div>
                <div class="flex items-center gap-2 text-xs text-slate-400">
                  <div class="h-1.5 w-1.5 rounded-full bg-violet-400"></div>
                  <span>Performance tuning & cleanup</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Previous Queries -->
      <div class="relative mt-8 glass rounded-3xl p-6">
        <div class="mx-auto w-full max-w-5xl">
          <div class="mb-3 flex items-center justify-between">
            <h2 class="text-lg font-semibold tracking-tight">Your previous queries</h2>
            <button id="refreshHistoryBtn" class="rounded-lg border border-white/10 bg-white/5 px-3 py-1.5 text-xs text-slate-300 transition hover:bg-white/10">Refresh</button>
          </div>
          <div id="historyList" class="grid gap-3 md:grid-cols-2">
            <div class="text-slate-400">No history yet.</div>
          </div>
        </div>
      </div>

      <!-- History Modal -->
      <div id="historyModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
        <div class="max-h-[85vh] w-full max-w-2xl overflow-auto rounded-2xl glass p-5 shadow-xl">
          <div class="mb-3 flex items-center justify-between">
            <h3 class="text-base font-semibold">Query details</h3>
            <button id="modalCloseBtn" class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs text-slate-300 hover:bg-white/10">Close</button>
          </div>
          <div id="modalBody" class="space-y-4 text-sm">
            <!-- Filled dynamically -->
          </div>
        </div>
      </div>

      <!-- Remote Session Modal -->
      <div id="remoteSessionModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/80 p-4">
        <div class="h-[90vh] w-full max-w-6xl rounded-2xl glass p-5 shadow-xl flex flex-col">
          <div class="mb-3 flex items-center justify-between flex-shrink-0">
            <div class="flex items-center gap-3">
              <div class="h-6 w-6 rounded-lg bg-gradient-to-br from-emerald-500 to-teal-400 flex items-center justify-center">
                <svg class="w-3 h-3 text-emerald-900" fill="currentColor" viewBox="0 0 20 20">
                  <path d="M3 4a1 1 0 011-1h12a1 1 0 011 1v2a1 1 0 01-1 1H4a1 1 0 01-1-1V4zM3 10a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H4a1 1 0 01-1-1v-6zM14 9a1 1 0 00-1 1v6a1 1 0 001 1h2a1 1 0 001-1v-6a1 1 0 00-1-1h-2z"/>
                </svg>
              </div>
              <div>
                <h3 class="text-base font-semibold">Remote Session - DESKTOP-AI-DEMO</h3>
                <div class="text-xs text-emerald-400">Connected via NinjaOne RMM</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <div class="rounded-full border border-emerald-400/30 bg-emerald-400/10 px-2 py-1 text-[10px] text-emerald-300">
                Session Active
              </div>
              <button id="remoteSessionClose" class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs text-slate-300 hover:bg-white/10">End Session</button>
            </div>
          </div>
          
          <div class="flex-1 grid grid-cols-1 lg:grid-cols-3 gap-4">
            <!-- Terminal/Command Panel -->
            <div class="lg:col-span-2 rounded-xl border border-white/10 bg-black/40 p-4 flex flex-col">
              <div class="flex items-center justify-between mb-3 text-xs text-slate-400">
                <div class="flex items-center gap-2">
                  <div class="flex gap-1">
                    <div class="w-2 h-2 rounded-full bg-red-400"></div>
                    <div class="w-2 h-2 rounded-full bg-amber-400"></div>
                    <div class="w-2 h-2 rounded-full bg-emerald-400"></div>
                  </div>
                  <span>AI Terminal Session</span>
                </div>
                <div id="sessionContext" class="text-cyan-400 hidden">Fixing: <span id="currentIssue">--</span></div>
              </div>
              <div id="terminalOutput" class="flex-1 font-mono text-xs text-green-300 overflow-y-auto min-h-64 bg-black/30 rounded p-3">
                <div class="text-cyan-400">Microsoft Windows [Version 10.0.19045.3570]</div>
                <div class="text-cyan-400">(c) Microsoft Corporation. All rights reserved.</div>
                <div class="mt-2"></div>
                <div><span class="text-amber-400">C:\Users\User&gt;</span> <span class="text-white">systeminfo | findstr /B /C:"OS Name" /C:"OS Version"</span></div>
                <div class="text-slate-300">OS Name: Microsoft Windows 10 Pro</div>
                <div class="text-slate-300">OS Version: 10.0.19045 N/A Build 19045</div>
                <div class="mt-1"><span class="text-amber-400">C:\Users\User&gt;</span> <span id="currentCommand" class="text-white animate-pulse">_</span></div>
              </div>
            </div>
            
            <!-- System Info Panel -->
            <div class="space-y-4">
              <!-- System Status -->
              <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                <div class="text-sm font-medium text-white mb-2">System Status</div>
                <div class="space-y-2 text-xs">
                  <div class="flex justify-between">
                    <span class="text-slate-400">CPU Usage:</span>
                    <span class="text-emerald-400" id="cpuUsage">23%</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Memory:</span>
                    <span class="text-cyan-400" id="memUsage">8.2/16 GB</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Disk C::</span>
                    <span class="text-amber-400" id="diskUsage">245/500 GB</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-slate-400">Network:</span>
                    <span class="text-emerald-400">Connected</span>
                  </div>
                </div>
              </div>
              
              <!-- AI Actions -->
              <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                <div class="text-sm font-medium text-white mb-2">AI Actions</div>
                <div class="space-y-1.5 text-xs">
                  <button class="ai-action-btn w-full text-left px-2 py-1.5 rounded border border-fuchsia-400/20 bg-fuchsia-400/10 text-fuchsia-200 hover:bg-fuchsia-400/20 transition" data-action="scan">
                    üîç Run System Scan
                  </button>
                  <button class="ai-action-btn w-full text-left px-2 py-1.5 rounded border border-cyan-400/20 bg-cyan-400/10 text-cyan-200 hover:bg-cyan-400/20 transition" data-action="optimize">
                    ‚ö° Optimize Performance
                  </button>
                  <button class="ai-action-btn w-full text-left px-2 py-1.5 rounded border border-emerald-400/20 bg-emerald-400/10 text-emerald-200 hover:bg-emerald-400/20 transition" data-action="update">
                    üì¶ Update Software
                  </button>
                  <button class="ai-action-btn w-full text-left px-2 py-1.5 rounded border border-amber-400/20 bg-amber-400/10 text-amber-200 hover:bg-amber-400/20 transition" data-action="cleanup">
                    üßπ Disk Cleanup
                  </button>
                </div>
              </div>
              
              <!-- Session Info -->
              <div class="rounded-xl border border-white/10 bg-white/5 p-3">
                <div class="text-sm font-medium text-white mb-2">Session Info</div>
                <div class="space-y-1 text-xs text-slate-400">
                  <div>Started: <span id="sessionStart" class="text-white">--:--</span></div>
                  <div>Commands: <span id="commandCount" class="text-white">2</span></div>
                  <div>Status: <span class="text-emerald-400">Active</span></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load funky effects
      const fxScript = document.createElement('script');
      fxScript.src = '/static/js/fx.js';
      fxScript.defer = true;
      document.head.appendChild(fxScript);

      // Check if user is logged in
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      if (!token) {
        window.location.href = '/login';
      }

      // Show admin link if the user is admin
      if (user && user.role === 'admin') {
        const adminLink = document.getElementById('adminLink');
        if (adminLink) adminLink.classList.remove('hidden');
      }

      function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login';
      }

      // Helpers
      function fmt(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      function checkIfRemoteFixable(issue, solution) {
        const remoteKeywords = [
          'install', 'update', 'restart', 'run command', 'registry', 'service', 
          'driver', 'software', 'system file', 'disk cleanup', 'defrag', 
          'network', 'firewall', 'permission', 'cache', 'temp files', 'optimize',
          'configure', 'setting', 'powershell', 'cmd', 'control panel'
        ];
        
        const text = (issue + ' ' + solution).toLowerCase();
        return remoteKeywords.some(keyword => text.includes(keyword));
      }

      function initiateContextualRemoteFix(issue, steps) {
        if (connectionState !== 'connected') {
          // Show connection prompt with context
          const conversation = document.getElementById('conversation');
          conversation.innerHTML = `
            <div class="space-y-3">
              <div class="p-3 rounded-lg border border-cyan-400/30 bg-cyan-400/5">
                <div class="flex items-center gap-2 mb-2">
                  <svg class="w-4 h-4 text-cyan-400" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"/>
                    <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"/>
                  </svg>
                  <span class="text-sm font-medium text-cyan-300">Remote Fix Required</span>
                </div>
                <p class="text-xs text-slate-300 mb-3">To automatically fix "<em>${issue.substring(0, 60)}${issue.length > 60 ? '...' : ''}</em>", I need to connect to your PC.</p>
                <button id="connectForFixBtn" class="btn-funky w-full rounded-lg px-3 py-2 text-xs font-semibold">Connect PC to Start Fix</button>
              </div>
            </div>
          `;
          
          document.getElementById('connectForFixBtn').addEventListener('click', () => {
            // Store the contextual fix info
            window.pendingRemoteFix = { issue, steps };
            // Trigger connection
            document.getElementById('connectPcBtn').click();
          });
        } else {
          // Already connected, start remote session with context
          startContextualRemoteSession(issue, steps);
        }
      }

      function startContextualRemoteSession(issue, steps) {
        // Store context for the session
        window.currentRemoteFix = { issue, steps };
        
        // Open remote session
        document.getElementById('remoteSessionBtn').click();
        
        // Update UI with context
        setTimeout(() => {
          document.getElementById('sessionContext').classList.remove('hidden');
          document.getElementById('currentIssue').textContent = issue.substring(0, 40) + (issue.length > 40 ? '...' : '');
          
          // Auto-start fixing process
          setTimeout(() => {
            executeContextualFix();
          }, 2000);
        }, 500);
      }

      function openModal(html) {
        const m = document.getElementById('historyModal');
        const body = document.getElementById('modalBody');
        body.innerHTML = html;
        m.classList.remove('hidden');
        m.classList.add('flex');
      }
      function closeModal() {
        const m = document.getElementById('historyModal');
        m.classList.add('hidden');
        m.classList.remove('flex');
      }
      document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
      document.getElementById('historyModal').addEventListener('click', (e) => {
        if (e.target.id === 'historyModal') closeModal();
      });

      async function loadHistory() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '<div class="text-slate-400">Loading‚Ä¶</div>';
        try {
          const res = await fetch('/history', { headers: { 'Authorization': `Bearer ${token}` } });
          if (!res.ok) throw new Error('Failed to fetch history');
          const items = await res.json();
          if (!items.length) {
            historyList.innerHTML = '<div class="text-slate-400">No history yet.</div>';
            return;
          }
          historyList.innerHTML = '';
          items.forEach(item => {
            const card = document.createElement('button');
            card.className = 'group rounded-xl border border-white/10 bg-white/5 p-3 text-left transition hover:bg-white/10 tilt';
            card.innerHTML = `
              <div class="line-clamp-2 text-sm text-slate-200">${fmt(item.question)}</div>
              <div class="mt-2 text-[11px] text-slate-400">Updated: ${new Date(item.updated_at).toLocaleString()}</div>
            `;
            card.addEventListener('click', async () => {
              const res2 = await fetch(`/history/${item.conversation_id}`, { headers: { 'Authorization': `Bearer ${token}` } });
              if (!res2.ok) return;
              const detail = await res2.json();
              // find latest user message and the first assistant message at/after it
              const msgs = Array.isArray(detail.messages) ? detail.messages : [];
              let userIdx = -1;
              for (let i = msgs.length - 1; i >= 0; i--) {
                const r = (msgs[i].role || '').toString().toLowerCase();
                if (r === 'user') { userIdx = i; break; }
              }
              let userMsg = userIdx >= 0 ? msgs[userIdx] : null;
              let assistantMsg = null;
              if (userIdx >= 0) {
                for (let j = userIdx; j < msgs.length; j++) {
                  const r = (msgs[j].role || '').toString().toLowerCase();
                  if (r === 'assistant') { assistantMsg = msgs[j]; break; }
                }
              } else {
                userMsg = msgs.find(m => (m.role || '').toString().toLowerCase() === 'user') || null;
                assistantMsg = msgs.find(m => (m.role || '').toString().toLowerCase() === 'assistant') || null;
              }
              const html = `
                <div>
                  <div class="mb-2 text-xs uppercase tracking-wide text-slate-400">Question</div>
                  <div class="rounded-lg border border-white/10 bg-black/30 p-3 text-slate-200">${fmt(userMsg ? userMsg.content : item.question)}</div>
                </div>
                <div>
                  <div class="mb-2 text-xs uppercase tracking-wide text-slate-400">Solution</div>
                  <div class="rounded-lg border border-white/10 bg-black/30 p-3 text-slate-200">${fmt(assistantMsg ? assistantMsg.content : (item.answer || 'No answer recorded.'))}</div>
                </div>
              `;
              openModal(html);
            });
            historyList.appendChild(card);
          });
        } catch (e) {
          console.error('Failed to load history', e);
          historyList.innerHTML = '<div class="text-rose-300">Failed to load history.</div>';
        }
      }

      document.getElementById('refreshHistoryBtn').addEventListener('click', loadHistory);

      // Initial load
      loadHistory();

      // AI Assistant functionality
      document.getElementById('assistantForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const messageInput = document.getElementById('messageInput');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnIcon = document.getElementById('btnIcon');
        const conversation = document.getElementById('conversation');
        const message = messageInput.value.trim();
        
        if (!message) return;
        
        // Show loading state
        submitBtn.disabled = true;
        btnText.textContent = 'Thinking‚Ä¶';
        btnIcon.style.display = 'none';
        
        // Clear previous result
        conversation.innerHTML = '<div class="text-slate-400">Processing your request...</div>';
        
        try {
          const response = await fetch('/webhook/assist-or-ticket', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ message })
          });
          
          if (response.ok) {
            const result = await response.json();
            
            if (result.action === 'answer') {
              // Check if this looks like a technical issue that could be fixed remotely
              const isRemoteFixable = checkIfRemoteFixable(message, result.reply_text);
              
              let remoteOfferHtml = '';
              if (isRemoteFixable) {
                remoteOfferHtml = `
                  <div class="mt-3 p-3 rounded-lg border border-cyan-400/30 bg-cyan-400/5">
                    <div class="flex items-center gap-2 mb-2">
                      <svg class="w-4 h-4 text-cyan-400" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M13 6a3 3 0 11-6 0 3 3 0 016 0zM18 8a2 2 0 11-4 0 2 2 0 014 0zM14 15a4 4 0 00-8 0v3h8v-3z"/>
                      </svg>
                      <span class="text-sm font-medium text-cyan-300">AI Remote Assistance Available</span>
                    </div>
                    <p class="text-xs text-slate-300 mb-3">I can perform these steps automatically on your PC if you'd like.</p>
                    <button id="offerRemoteFixBtn" class="btn-funky w-full rounded-lg px-3 py-2 text-xs font-semibold shadow-[0_8px_20px_-8px_rgba(34,211,238,0.6)]" data-steps="${btoa(result.reply_text)}" data-issue="${btoa(message)}">
                      ü§ñ Let AI Fix This Remotely
                    </button>
                  </div>
                `;
              }
              
              conversation.innerHTML = `
                <div class="space-y-2">
                  <div class="inline-flex items-center gap-2 rounded-full border border-emerald-400/30 bg-emerald-400/10 px-2 py-1 text-[10px] uppercase tracking-wide text-emerald-300">
                    <span>AI Solution</span>
                    <span class="ml-1 inline-block rounded-full bg-emerald-400/20 px-1.5 py-0.5 text-[10px] text-emerald-200">
                      ${Math.round(result.confidence * 100)}%
                    </span>
                  </div>
                  <p class="whitespace-pre-wrap leading-relaxed text-slate-200">${result.reply_text}</p>
                  ${remoteOfferHtml}
                </div>
              `;
              
              // Add event listener for remote fix button if it exists
              const offerBtn = document.getElementById('offerRemoteFixBtn');
              if (offerBtn) {
                offerBtn.addEventListener('click', () => {
                  const steps = atob(offerBtn.dataset.steps);
                  const issue = atob(offerBtn.dataset.issue);
                  initiateContextualRemoteFix(issue, steps);
                });
              }
            } else if (result.action === 'escalate') {
              conversation.innerHTML = `
                <div class="space-y-2">
                  <div class="inline-flex items-center gap-2 rounded-full border border-cyan-400/30 bg-cyan-400/10 px-2 py-1 text-[10px] uppercase tracking-wide text-cyan-300">
                    Ticket Created
                  </div>
                  <p>
                    We've opened ticket <b>#${result.ticket_id}</b> (status: <b>${result.status}</b>). Our team will follow up.
                  </p>
                </div>
              `;
            }
          } else {
            const error = await response.json();
            conversation.innerHTML = `
              <div class="rounded-lg border border-rose-500/30 bg-rose-500/10 p-3 text-rose-200">
                ‚ö†Ô∏è ${error.detail || 'Something went wrong'}
              </div>
            `;
          }
        } catch (error) {
          console.error('Assistant request failed', error);
          conversation.innerHTML = `
            <div class="rounded-lg border border-rose-500/30 bg-rose-500/10 p-3 text-rose-200">
              ‚ö†Ô∏è Network error. Please try again.
            </div>
          `;
        } finally {
          submitBtn.disabled = false;
          btnText.textContent = 'Ask';
          btnIcon.style.display = 'inline';
          messageInput.value = '';
          // Refresh history after sending
          loadHistory();
        }
      });

      // Remote PC Connection Demo
      let connectionState = 'disconnected'; // disconnected, connecting, connected
      const connectBtn = document.getElementById('connectPcBtn');
      const connectBtnText = document.getElementById('connectBtnText');
      const connectionStatus = document.getElementById('connectionStatus');
      const connectionText = document.getElementById('connectionText');

      const updateConnectionUI = (state) => {
        switch(state) {
          case 'disconnected':
            connectionStatus.className = 'h-3 w-3 rounded-full bg-red-400 shadow-lg shadow-red-400/50';
            connectionText.textContent = 'Not connected';
            connectBtnText.textContent = 'Connect My PC';
            connectBtn.disabled = false;
            break;
          case 'connecting':
            connectionStatus.className = 'h-3 w-3 rounded-full bg-amber-400 shadow-lg shadow-amber-400/50 animate-pulse';
            connectionText.textContent = 'Establishing secure connection...';
            connectBtnText.textContent = 'Connecting...';
            connectBtn.disabled = true;
            break;
          case 'connected':
            connectionStatus.className = 'h-3 w-3 rounded-full bg-emerald-400 shadow-lg shadow-emerald-400/50';
            connectionText.textContent = 'Connected ‚Ä¢ AI ready to assist';
            connectBtnText.textContent = 'Disconnect';
            connectBtn.disabled = false;
            break;
        }
      };

      connectBtn.addEventListener('click', async () => {
        if (connectionState === 'disconnected') {
          connectionState = 'connecting';
          updateConnectionUI('connecting');
          
          // Simulate connection process
          await new Promise(resolve => setTimeout(resolve, 2000));
          
          connectionState = 'connected';
          updateConnectionUI('connected');
          
          // Show Remote Session button
          document.getElementById('remoteSessionBtn').classList.remove('hidden');
          
          // Check if there's a pending remote fix
          if (window.pendingRemoteFix) {
            const { issue, steps } = window.pendingRemoteFix;
            delete window.pendingRemoteFix;
            
            // Show contextual success message
            const conversation = document.getElementById('conversation');
            conversation.innerHTML = `
              <div class="space-y-2">
                <div class="inline-flex items-center gap-2 rounded-full border border-emerald-400/30 bg-emerald-400/10 px-2 py-1 text-[10px] uppercase tracking-wide text-emerald-300">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                  PC Connected - Ready to Fix
                </div>
                <p class="whitespace-pre-wrap leading-relaxed text-slate-200">üéâ Connected! Starting automatic fix for your issue...</p>
              </div>
            `;
            
            // Auto-start the contextual remote fix
            setTimeout(() => {
              startContextualRemoteSession(issue, steps);
            }, 2000);
          } else {
            // Show general success message
            const conversation = document.getElementById('conversation');
            const originalContent = conversation.innerHTML;
            conversation.innerHTML = `
              <div class="space-y-2">
                <div class="inline-flex items-center gap-2 rounded-full border border-emerald-400/30 bg-emerald-400/10 px-2 py-1 text-[10px] uppercase tracking-wide text-emerald-300">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
                  PC Connected
                </div>
                <p class="whitespace-pre-wrap leading-relaxed text-slate-200">üéâ Your PC is now connected! AI can now remotely diagnose and fix issues automatically. Try asking about any IT problem or open a remote session.</p>
              </div>
            `;
            
            // Restore original content after 4 seconds
            setTimeout(() => {
              conversation.innerHTML = originalContent;
            }, 4000);
          }
          
        } else if (connectionState === 'connected') {
          connectionState = 'disconnected';
          updateConnectionUI('disconnected');
          
          // Hide Remote Session button
          document.getElementById('remoteSessionBtn').classList.add('hidden');
          
          // Show disconnection message
          const conversation = document.getElementById('conversation');
          const originalContent = conversation.innerHTML;
          conversation.innerHTML = `
            <div class="rounded-lg border border-slate-500/30 bg-slate-500/10 p-3 text-slate-200">
              üîå PC disconnected. Connect again to enable remote AI assistance.
            </div>
          `;
          
          setTimeout(() => {
            conversation.innerHTML = originalContent;
          }, 3000);
        }
      });

      // Remote Session Modal
      const remoteSessionModal = document.getElementById('remoteSessionModal');
      const remoteSessionBtn = document.getElementById('remoteSessionBtn');
      const remoteSessionClose = document.getElementById('remoteSessionClose');
      let sessionStartTime = null;
      let commandCounter = 2;

      remoteSessionBtn.addEventListener('click', () => {
        sessionStartTime = new Date();
        document.getElementById('sessionStart').textContent = sessionStartTime.toLocaleTimeString();
        remoteSessionModal.classList.remove('hidden');
        remoteSessionModal.classList.add('flex');
        
        // Start simulated terminal activity
        startTerminalSimulation();
      });

      remoteSessionClose.addEventListener('click', () => {
        remoteSessionModal.classList.add('hidden');
        remoteSessionModal.classList.remove('flex');
      });

      remoteSessionModal.addEventListener('click', (e) => {
        if (e.target.id === 'remoteSessionModal') {
          remoteSessionModal.classList.add('hidden');
          remoteSessionModal.classList.remove('flex');
        }
      });

      // Terminal simulation
      const terminalCommands = [
        { cmd: 'dism /online /cleanup-image /analyzecomponentstore', output: ['Deployment Image Servicing and Management tool', 'Version: 10.0.19041.844', '', 'Component Store (WinSxS) information:', '  Component Store Size : 8.12 GB', '  Shared with Windows : 6.85 GB', '  Backups and Disabled Features : 1.27 GB', '  Cache and Temporary Data : 0 bytes', '', 'Component Store Cleanup Recommended : Yes'] },
        { cmd: 'sfc /scannow', output: ['Microsoft Windows [Version 10.0.19045.3570]', 'Beginning system scan. This process will take some time.', '', 'Beginning verification phase of system scan.', 'Verification 100% complete.', '', 'Windows Resource Protection found corrupt files and successfully repaired them.', 'Details are included in the CBS.Log windir\\Logs\\CBS\\CBS.log.'] },
        { cmd: 'powershell "Get-WmiObject Win32_LogicalDisk | Select-Object Size,FreeSpace,DeviceID"', output: ['DeviceID      Size        FreeSpace', '--------      ----        ---------', 'C:       536870912000  268435456000', 'D:       1073741824000  805306368000'] },
        { cmd: 'netsh wlan show profiles', output: ['Profiles on interface Wi-Fi:', '', 'Group policy profiles (read only)', '---------------------------------', '    <None>', '', 'User profiles', '-------------', '    All User Profile     : HomeNetwork', '    All User Profile     : OfficeWiFi'] }
      ];

      let currentCmdIndex = 0;
      let terminalActive = false;

      function startTerminalSimulation() {
        if (terminalActive) return;
        terminalActive = true;
        
        // Update system stats periodically
        updateSystemStats();
        setInterval(updateSystemStats, 3000);
      }

      function executeAIAction(action) {
        const terminalOutput = document.getElementById('terminalOutput');
        const currentCommand = document.getElementById('currentCommand');
        const commands = {
          scan: { cmd: 'powershell "Get-ComputerInfo | Select-Object TotalPhysicalMemory,CsProcessors"', output: ['TotalPhysicalMemory : 17179869184', 'CsProcessors        : {Intel(R) Core(TM) i7-9700K CPU @ 3.60GHz}', '', 'AI Analysis: System running optimally. No issues detected.'] },
          optimize: { cmd: 'powershell "Get-Process | Sort-Object CPU -desc | Select-Object -first 5"', output: ['ProcessName      CPU(s)', '-----------      ------', 'chrome          245.67', 'firefox          89.23', 'code             56.78', 'discord          34.12', 'explorer         12.45', '', 'AI: Optimizing high-CPU processes... Done.'] },
          update: { cmd: 'powershell "Get-WindowsUpdate -Online"', output: ['Finding available updates...', '', 'KB5034441 - 2024-01 Security Update for Windows 10', 'KB5034763 - 2024-01 Cumulative Update for .NET Framework', '', 'AI: 2 updates available. Installing... Complete.'] },
          cleanup: { cmd: 'cleanmgr /sagerun:1', output: ['Disk Cleanup is calculating space...', '', 'Found 2.3 GB of temporary files', 'Found 1.7 GB of recycle bin files', 'Found 850 MB of browser cache', '', 'AI: Cleanup complete. 4.85 GB freed.'] }
        };

        const actionCmd = commands[action];
        if (!actionCmd) return;

        currentCommand.textContent = actionCmd.cmd;
        commandCounter++;
        document.getElementById('commandCount').textContent = commandCounter;

        setTimeout(() => {
          // Add command to terminal
          const cmdDiv = document.createElement('div');
          cmdDiv.innerHTML = `<span class="text-amber-400">C:\\Users\\User&gt;</span> <span class="text-white">${actionCmd.cmd}</span>`;
          terminalOutput.insertBefore(cmdDiv, currentCommand.parentElement);

          // Add output
          actionCmd.output.forEach((line, i) => {
            setTimeout(() => {
              const outputDiv = document.createElement('div');
              outputDiv.className = line.startsWith('AI') ? 'text-cyan-300' : 'text-slate-300';
              outputDiv.textContent = line;
              terminalOutput.insertBefore(outputDiv, currentCommand.parentElement);
              terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }, i * 100);
          });

          setTimeout(() => {
            currentCommand.textContent = '_';
          }, actionCmd.output.length * 100 + 500);
        }, 1000);
      }

      function updateSystemStats() {
        // Simulate changing system stats
        const cpu = Math.floor(Math.random() * 40) + 15;
        const memUsed = (Math.random() * 4 + 6).toFixed(1);
        const diskUsed = Math.floor(Math.random() * 50) + 240;
        
        document.getElementById('cpuUsage').textContent = `${cpu}%`;
        document.getElementById('memUsage').textContent = `${memUsed}/16 GB`;
        document.getElementById('diskUsage').textContent = `${diskUsed}/500 GB`;
      }

      function executeContextualFix() {
        if (!window.currentRemoteFix) return;
        
        const { issue, steps } = window.currentRemoteFix;
        const terminalOutput = document.getElementById('terminalOutput');
        const currentCommand = document.getElementById('currentCommand');
        
        // Generate contextual commands based on the issue
        const contextualCommands = generateFixCommands(issue, steps);
        
        let cmdIndex = 0;
        function runNextCommand() {
          if (cmdIndex >= contextualCommands.length) {
            // Show completion message
            setTimeout(() => {
              const completionDiv = document.createElement('div');
              completionDiv.className = 'text-emerald-300 font-semibold';
              completionDiv.textContent = '‚úÖ AI Fix Complete! Issue resolved successfully.';
              terminalOutput.insertBefore(completionDiv, currentCommand.parentElement);
              currentCommand.textContent = '_';
              terminalOutput.scrollTop = terminalOutput.scrollHeight;
            }, 1000);
            return;
          }
          
          const cmd = contextualCommands[cmdIndex];
          currentCommand.textContent = cmd.cmd;
          commandCounter++;
          document.getElementById('commandCount').textContent = commandCounter;
          
          setTimeout(() => {
            // Add command to terminal
            const cmdDiv = document.createElement('div');
            cmdDiv.innerHTML = `<span class="text-amber-400">C:\\Users\\User&gt;</span> <span class="text-white">${cmd.cmd}</span>`;
            terminalOutput.insertBefore(cmdDiv, currentCommand.parentElement);

            // Add output
            cmd.output.forEach((line, i) => {
              setTimeout(() => {
                const outputDiv = document.createElement('div');
                outputDiv.className = line.startsWith('AI') || line.startsWith('‚úÖ') ? 'text-cyan-300' : 'text-slate-300';
                outputDiv.textContent = line;
                terminalOutput.insertBefore(outputDiv, currentCommand.parentElement);
                terminalOutput.scrollTop = terminalOutput.scrollHeight;
              }, i * 150);
            });

            setTimeout(() => {
              cmdIndex++;
              runNextCommand();
            }, cmd.output.length * 150 + 1500);
          }, 1000);
        }
        
        runNextCommand();
      }
      
      function generateFixCommands(issue, steps) {
        const issueLower = issue.toLowerCase();
        
        // Generate contextual commands based on issue type
        if (issueLower.includes('slow') || issueLower.includes('performance')) {
          return [
            { cmd: 'tasklist /svc | findstr /i "high"', output: ['Scanning for high-resource processes...', 'Found 3 processes consuming excessive resources', 'AI: Identifying optimization targets'] },
            { cmd: 'powershell "Get-Process | Sort-Object CPU -desc | Select-Object -first 5"', output: ['chrome.exe        245.67', 'firefox.exe        89.23', 'teams.exe          56.78', 'AI: Optimizing process priorities...', '‚úÖ Performance improved by 40%'] }
          ];
        } else if (issueLower.includes('update') || issueLower.includes('software')) {
          return [
            { cmd: 'powershell "Get-WindowsUpdate -Online"', output: ['Checking for available updates...', 'Found 3 critical updates', 'KB5034441 - Security Update', 'KB5034763 - .NET Framework Update', 'AI: Installing updates automatically...'] },
            { cmd: 'powershell "Install-WindowsUpdate -AcceptAll -AutoReboot:$false"', output: ['Installing updates...', 'Update 1/3 complete', 'Update 2/3 complete', 'Update 3/3 complete', '‚úÖ All updates installed successfully'] }
          ];
        } else if (issueLower.includes('network') || issueLower.includes('internet') || issueLower.includes('wifi')) {
          return [
            { cmd: 'ipconfig /release && ipconfig /renew', output: ['Releasing IP configuration...', 'Renewing IP configuration...', 'AI: Refreshing network settings'] },
            { cmd: 'netsh winsock reset', output: ['Resetting Winsock catalog...', 'Successfully reset the Winsock Catalog', 'AI: Network stack refreshed', '‚úÖ Network connectivity restored'] }
          ];
        } else if (issueLower.includes('disk') || issueLower.includes('storage') || issueLower.includes('space')) {
          return [
            { cmd: 'cleanmgr /sagerun:1', output: ['Analyzing disk usage...', 'Found 2.3 GB temporary files', 'Found 1.7 GB recycle bin files', 'AI: Cleaning disk space...'] },
            { cmd: 'powershell "Get-ChildItem -Path C:\\temp -Recurse | Remove-Item -Force"', output: ['Removing temporary files...', 'Cleared 4.2 GB of disk space', '‚úÖ Disk cleanup completed successfully'] }
          ];
        } else {
          // Generic fix commands
          return [
            { cmd: 'sfc /scannow', output: ['Scanning system files...', 'Windows Resource Protection found corrupt files', 'AI: Repairing system integrity...', '‚úÖ System files repaired'] },
            { cmd: 'powershell "Restart-Service -Name Themes,AudioSrv,BITS -Force"', output: ['Restarting essential services...', 'Service restart complete', 'AI: System services optimized', '‚úÖ Issue resolved successfully'] }
          ];
        }
      }

      // AI Action buttons
      document.querySelectorAll('.ai-action-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.dataset.action;
          executeAIAction(action);
        });
      });

      // Initialize connection UI
      updateConnectionUI('disconnected');
    </script>
  </body>
</html>

