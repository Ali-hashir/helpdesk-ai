<!DOCTYPE html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard — Helpdesk‑AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preload" href="/static/css/theme.css" as="style">
    <link rel="stylesheet" href="/static/css/theme.css">
  </head>
  <body class="min-h-screen text-slate-100 grain vignette">
    <!-- Animated BG Orbs -->
    <div class="bg-orbs">
      <div class="orb f1"></div>
      <div class="orb f2"></div>
      <div class="orb f3"></div>
    </div>

    <div class="relative mx-auto max-w-5xl px-6 py-10">
      <!-- Header -->
      <header class="mb-8 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="h-10 w-10 rounded-xl bg-gradient-to-br from-fuchsia-500 to-cyan-400 shadow-lg shadow-fuchsia-500/30 tilt"></div>
          <div>
            <div class="text-xl font-semibold tracking-tight">Welcome, {{ user.username }}!</div>
            <div class="text-xs text-slate-400">Ask anything — I’ll fix it or open a ticket</div>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <a href="/admin/tickets" class="hidden rounded-lg border border-white/10 bg-white/5 px-3 py-2 text-sm text-slate-300 transition hover:bg-white/10" id="adminLink">Admin</a>
          <button onclick="logout()" class="btn-funky rounded-lg px-3 py-2 text-sm">Logout</button>
        </div>
      </header>

      <!-- AI Assistant Widget -->
      <div class="glass rounded-3xl p-6">
        <div class="mx-auto w-full max-w-2xl">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold tracking-tight">Helpdesk‑AI Assistant</h2>
            <div class="rounded-full border border-white/10 bg-white/5 px-2 py-1 text-[10px] text-white/70">
              beta
            </div>
          </div>

          <!-- Conversation area -->
          <div id="conversation" class="mt-4 rounded-xl bubble p-3 text-sm text-slate-200 shadow-inner">
            <div class="text-slate-400">Ask about any IT issue. I'll propose a fix or open a ticket.</div>
          </div>

          <!-- Form -->
          <form id="assistantForm" class="mt-4 grid gap-3">
            <textarea
              id="messageInput"
              class="min-h-28 w-full resize-y rounded-2xl border border-white/10 bg-white/5 p-3 text-sm text-white placeholder:text-slate-400 shadow-[inset_0_1px_0_rgba(255,255,255,0.06)] outline-none backdrop-blur transition focus:border-fuchsia-400/40 focus:ring-2 focus:ring-fuchsia-400/20 tilt"
              placeholder="Describe your issue…"
              rows="4"
              required
            ></textarea>
            <button
              type="submit"
              id="submitBtn"
              class="btn-funky relative inline-flex items-center justify-center gap-2 overflow-hidden rounded-2xl px-4 py-2.5 text-sm font-semibold shadow-[0_10px_30px_-10px_rgba(244,114,182,0.6)] focus:outline-none enabled:hover:scale-[1.02] disabled:opacity-60"
            >
              <span id="btnText" class="relative z-10">Ask</span>
              <span id="btnIcon" class="relative z-10 text-base">→</span>
            </button>
          </form>

          <div class="mt-2 text-[11px] text-slate-400">We may open a ticket automatically if a human expert is needed.</div>
        </div>
      </div>

      <!-- Previous Queries -->
      <div class="relative mt-8 glass rounded-3xl p-6">
        <div class="mx-auto w-full max-w-5xl">
          <div class="mb-3 flex items-center justify-between">
            <h2 class="text-lg font-semibold tracking-tight">Your previous queries</h2>
            <button id="refreshHistoryBtn" class="rounded-lg border border-white/10 bg-white/5 px-3 py-1.5 text-xs text-slate-300 transition hover:bg-white/10">Refresh</button>
          </div>
          <div id="historyList" class="grid gap-3 md:grid-cols-2">
            <div class="text-slate-400">No history yet.</div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div id="historyModal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 p-4">
        <div class="max-h-[85vh] w-full max-w-2xl overflow-auto rounded-2xl glass p-5 shadow-xl">
          <div class="mb-3 flex items-center justify-between">
            <h3 class="text-base font-semibold">Query details</h3>
            <button id="modalCloseBtn" class="rounded-md border border-white/10 bg-white/5 px-2 py-1 text-xs text-slate-300 hover:bg-white/10">Close</button>
          </div>
          <div id="modalBody" class="space-y-4 text-sm">
            <!-- Filled dynamically -->
          </div>
        </div>
      </div>
    </div>

    <script>
      // Load funky effects
      const fxScript = document.createElement('script');
      fxScript.src = '/static/js/fx.js';
      fxScript.defer = true;
      document.head.appendChild(fxScript);

      // Check if user is logged in
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      if (!token) {
        window.location.href = '/login';
      }

      // Show admin link if the user is admin
      if (user && user.role === 'admin') {
        const adminLink = document.getElementById('adminLink');
        if (adminLink) adminLink.classList.remove('hidden');
      }

      function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        window.location.href = '/login';
      }

      // Helpers
      function fmt(str) {
        return (str || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
      }

      function openModal(html) {
        const m = document.getElementById('historyModal');
        const body = document.getElementById('modalBody');
        body.innerHTML = html;
        m.classList.remove('hidden');
        m.classList.add('flex');
      }
      function closeModal() {
        const m = document.getElementById('historyModal');
        m.classList.add('hidden');
        m.classList.remove('flex');
      }
      document.getElementById('modalCloseBtn').addEventListener('click', closeModal);
      document.getElementById('historyModal').addEventListener('click', (e) => {
        if (e.target.id === 'historyModal') closeModal();
      });

      async function loadHistory() {
        const historyList = document.getElementById('historyList');
        historyList.innerHTML = '<div class="text-slate-400">Loading…</div>';
        try {
          const res = await fetch('/history', { headers: { 'Authorization': `Bearer ${token}` } });
          if (!res.ok) throw new Error('Failed to fetch history');
          const items = await res.json();
          if (!items.length) {
            historyList.innerHTML = '<div class="text-slate-400">No history yet.</div>';
            return;
          }
          historyList.innerHTML = '';
          items.forEach(item => {
            const card = document.createElement('button');
            card.className = 'group rounded-xl border border-white/10 bg-white/5 p-3 text-left transition hover:bg-white/10 tilt';
            card.innerHTML = `
              <div class="line-clamp-2 text-sm text-slate-200">${fmt(item.question)}</div>
              <div class="mt-2 text-[11px] text-slate-400">Updated: ${new Date(item.updated_at).toLocaleString()}</div>
            `;
            card.addEventListener('click', async () => {
              const res2 = await fetch(`/history/${item.conversation_id}`, { headers: { 'Authorization': `Bearer ${token}` } });
              if (!res2.ok) return;
              const detail = await res2.json();
              // find latest user message and the first assistant message at/after it
              const msgs = Array.isArray(detail.messages) ? detail.messages : [];
              let userIdx = -1;
              for (let i = msgs.length - 1; i >= 0; i--) {
                const r = (msgs[i].role || '').toString().toLowerCase();
                if (r === 'user') { userIdx = i; break; }
              }
              let userMsg = userIdx >= 0 ? msgs[userIdx] : null;
              let assistantMsg = null;
              if (userIdx >= 0) {
                for (let j = userIdx; j < msgs.length; j++) {
                  const r = (msgs[j].role || '').toString().toLowerCase();
                  if (r === 'assistant') { assistantMsg = msgs[j]; break; }
                }
              } else {
                userMsg = msgs.find(m => (m.role || '').toString().toLowerCase() === 'user') || null;
                assistantMsg = msgs.find(m => (m.role || '').toString().toLowerCase() === 'assistant') || null;
              }
              const html = `
                <div>
                  <div class="mb-2 text-xs uppercase tracking-wide text-slate-400">Question</div>
                  <div class="rounded-lg border border-white/10 bg-black/30 p-3 text-slate-200">${fmt(userMsg ? userMsg.content : item.question)}</div>
                </div>
                <div>
                  <div class="mb-2 text-xs uppercase tracking-wide text-slate-400">Solution</div>
                  <div class="rounded-lg border border-white/10 bg-black/30 p-3 text-slate-200">${fmt(assistantMsg ? assistantMsg.content : (item.answer || 'No answer recorded.'))}</div>
                </div>
              `;
              openModal(html);
            });
            historyList.appendChild(card);
          });
        } catch (e) {
          console.error('Failed to load history', e);
          historyList.innerHTML = '<div class="text-rose-300">Failed to load history.</div>';
        }
      }

      document.getElementById('refreshHistoryBtn').addEventListener('click', loadHistory);

      // Initial load
      loadHistory();

      // AI Assistant functionality
      document.getElementById('assistantForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const messageInput = document.getElementById('messageInput');
        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnIcon = document.getElementById('btnIcon');
        const conversation = document.getElementById('conversation');
        const message = messageInput.value.trim();
        
        if (!message) return;
        
        // Show loading state
        submitBtn.disabled = true;
        btnText.textContent = 'Thinking…';
        btnIcon.style.display = 'none';
        
        // Clear previous result
        conversation.innerHTML = '<div class="text-slate-400">Processing your request...</div>';
        
        try {
          const response = await fetch('/webhook/assist-or-ticket', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ message })
          });
          
          if (response.ok) {
            const result = await response.json();
            
            if (result.action === 'answer') {
              conversation.innerHTML = `
                <div class="space-y-2">
                  <div class="inline-flex items-center gap-2 rounded-full border border-emerald-400/30 bg-emerald-400/10 px-2 py-1 text-[10px] uppercase tracking-wide text-emerald-300">
                    <span>AI Answer</span>
                    <span class="ml-1 inline-block rounded-full bg-emerald-400/20 px-1.5 py-0.5 text-[10px] text-emerald-200">
                      ${Math.round(result.confidence * 100)}%
                    </span>
                  </div>
                  <p class="whitespace-pre-wrap leading-relaxed text-slate-200">${result.reply_text}</p>
                </div>
              `;
            } else if (result.action === 'escalate') {
              conversation.innerHTML = `
                <div class="space-y-2">
                  <div class="inline-flex items-center gap-2 rounded-full border border-cyan-400/30 bg-cyan-400/10 px-2 py-1 text-[10px] uppercase tracking-wide text-cyan-300">
                    Ticket Created
                  </div>
                  <p>
                    We've opened ticket <b>#${result.ticket_id}</b> (status: <b>${result.status}</b>). Our team will follow up.
                  </p>
                </div>
              `;
            }
          } else {
            const error = await response.json();
            conversation.innerHTML = `
              <div class="rounded-lg border border-rose-500/30 bg-rose-500/10 p-3 text-rose-200">
                ⚠️ ${error.detail || 'Something went wrong'}
              </div>
            `;
          }
        } catch (error) {
          console.error('Assistant request failed', error);
          conversation.innerHTML = `
            <div class="rounded-lg border border-rose-500/30 bg-rose-500/10 p-3 text-rose-200">
              ⚠️ Network error. Please try again.
            </div>
          `;
        } finally {
          submitBtn.disabled = false;
          btnText.textContent = 'Ask';
          btnIcon.style.display = 'inline';
          messageInput.value = '';
          // Refresh history after sending
          loadHistory();
        }
      });
    </script>
  </body>
</html>

